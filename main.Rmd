---
title: "STA305"
author: "Pierre Catoire"
date: "03/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(305)
```

## Projet STA 305

```{r}
library(bayesmeta)
library(metafor)
library(rjags)
library(HDInterval)
```

## Application au TP

```{r}
df = read.csv("dataaxfors.csv")
df = df[!is.na(df$GROUP) & !is.na(df$TREATMENTDEATH),]
df.pubs.hcq = df[df$GROUP=="AP",]
df.nopubs.hcq = df[df$GROUP=="ANP",]
df.hcq = df[df$GROUP=="AP" | df$GROUP == "ANP",]
df.cq = df[df$GROUP=="B",]
```


### Analyse via package bayesmeta

```{r}
hp=list(maxtau = 1000,
        varmu = 1000)

custom.bayesmeta = function(data,hyperprior,measure="OR"){
  es = escalc(measure = measure,
              ai = TREATMENTDEATH,
              n1i = TREATMENTTOT,
              ci = CONTROLDEATH,
              n2i = CONTROLTOT,
              slab = PUBRID,
              data = data)
  
  es = es[,c("PUBRID","yi","vi")]
  
  result = bayesmeta(y = es$yi,
                         sigma = sqrt(es$vi),
                         labels = es$PUBRID,
                         tau.prior = function(t) {
                           dunif(t, max = hyperprior$maxtau)
                           },
                         mu.prior = c(0, hyperprior$varmu),
                         interval.type = "central")
  
  return(result)
}

res.pubs.hcq = custom.bayesmeta(df.pubs.hcq,hp) #Hydroxychloroquine, essais publiés seuls
res.nopubs.hcq = custom.bayesmeta(df.nopubs.hcq,hp) #Hydroxychloroquine, essais non publiés seuls
res.all.hcq = custom.bayesmeta(df.hcq,hp) #Hydroxychloroquine, ensemble des essais
res.cq = custom.bayesmeta(df.cq,hp) #Chloroquine, ensemble des essais
```

### Analyse de sensibilité :

- Hyperpriors
- OR correction

### Analyse en sous-groupes :

- Dose HCQ : 
  - > 1600 mg J1 et > 800 mg J2 vs autres
  
```{r}
df.lowdose.pubs.hcq = df[df$GROUP =="AP" & df$DOSECLASS == "LD",]
df.highdose.pubs.hcq = df[df$GROUP =="AP" & df$DOSECLASS == "HD",]
df.lowdose.all.hcq = df[df$DOSECLASS == "LD",]
df.highdose.all.hcq = df[df$DOSECLASS == "HD",]

res.hd.pubs.hcq = custom.bayesmeta(df.highdose.pubs.hcq,hp) #Hydroxychloroquine à dose forte, essais publiés seuls
res.ld.pubs.hcq = custom.bayesmeta(df.lowdose.pubs.hcq,hp) #Hydroxychloroquine à dose modérée, essais publiés seuls
res.hd.all.hcq = custom.bayesmeta(df.highdose.all.hcq,hp) #Hydroxychloroquine à dose forte, ensemble des études
res.ld.all.hcq = custom.bayesmeta(df.lowdose.all.hcq,hp) #Hydroxychloroquine à dose modérée, ensemble des études
```
